<%- include('../layouts/header') %> <%- include('../layouts/head-links') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container line-break-top line-break text-center py-3">
  <span class="shadow-heading">DashBoard</span>
</div>
<div class="col-md-10 mx-auto my-3">
  <div class="row m-0">
      <div class="col-xl-3 col-lg-6 mb-2">
          <div class="card l-bg-cherry">
              <div class="card-statistic-3 p-4">
                  <div class="card-icon card-icon-large"><i class="fas fa-shopping-cart"></i></div>
                  <div class="mb-4">
                      <h5 class="card-title mb-0">Orders</h5>
                  </div>
                  <div class="row align-items-center mb-2 d-flex">
                      <div class="col-8">
                          <h4 class="d-flex align-items-center mb-0">
                              <%=locals.orderCount%>
                          </h4>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-lg-6 mb-2 ">
          <div class="card l-bg-blue-dark">
              <div class="card-statistic-3 p-4">
                  <div class="card-icon card-icon-large"><i class="fas fa-users"></i></div>
                  <div class="mb-4">
                      <h5 class="card-title mb-0">Customers</h5>
                  </div>
                  <div class="row align-items-center mb-2 d-flex">
                      <div class="col-8">
                          <h4 class="d-flex align-items-center mb-0">
                            <%=locals.customerCount%>
                          </h4>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-lg-6 mb-2">
          <div class="card l-bg-green-dark">
              <div class="card-statistic-3 p-4">
                  <div class="card-icon card-icon-large"><i class="fas fa-clock"></i></div>
                  <div class="mb-4">
                      <h5 class="card-title mb-0">Products</h5>
                  </div>
                  <div class="row align-items-center mb-2 d-flex">
                      <div class="col-8">
                          <h4 class="d-flex align-items-center mb-0">
                            <%=locals.productCount%>
                          </h4>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <div class="col-xl-3 col-lg-6 mb-2">
          <div class="card l-bg-orange-dark">
              <div class="card-statistic-3 p-4">
                  <div class="card-icon card-icon-large"><i class="fas fa-dollar-sign"></i></div>
                  <div class="mb-4">
                      <h5 class="card-title mb-0">Revenue ₹</h5>
                  </div>
                  <div class="row align-items-center mb-2 d-flex">
                      <div class="col-8">
                          <h4 class="d-flex align-items-center mb-0">
                            <%=locals.totalRevenue%>
                          </h4>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>
<div class="container">
  <h6 class="text-center my-2" >Sales Analytics - <%let currentYear = new Date();%>
    <%currentYear = currentYear.getFullYear();%><%=currentYear%></h6>
  <div class="row my-3" id="charts">
    <div class="col-lg-6">
      
      <canvas id="myChart"></canvas>
    </div>
    <div class="col-lg-6">
      <canvas id="myChart2"></canvas>
    </div>
  </div>
  <h6 class="text-center" >Order Status</h6>
  <div class="col-lg-4 mx-auto">
    <canvas id="myChart3"></canvas>
  </div>
 
</div>

<!-- Table -->
<div class="container  my-5" style="max-width: 1100px" >
  <h6 class="text-center" >Recent Orders</h6>
  <%if(recentOrders){%>
    <table class="table table-hover cell-border fw-light nowrap" id="dataTable" style="width: 100%;">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Bill</th>
          <th>Status</th>
          <th>Payment</th>
        </tr>
      </thead>
      <tbody id="tableBody" style="font-size: 0.85rem;">
        
       <%recentOrders.forEach((order)=>{%>
        <tr>
          <td><%=order._id%></td>
          <td><%=order.customer.email%></td>
          <td><%= order.finalPrice %></td>
          <td><% if (order.delivered != true) {%>
              <i class="fa fa-truck text-warning"></i><span>In Transit</span>
            <%}else{%>
            <span
              ><i class="fa fa-check text-success"></i
              ><span>Delivered</span> <%} %> <br /><% if (order.delivered ==
              true) {%>
              <span><%=moment(order.deliveredOn).format('lll')%></span>
              <%}%></span</td>
          <td><%= order.modeOfPayment %></td>
        </tr>
        <%})%>
      </tbody>
    </table>
    <%}%>
</div>
<!-- <input id="chartYear" type="number" min="2023" max="2050" step="1" value="2023" />
<button  onclick="chartYear()" class="btn btn-dark btn-sm">Change Year</button> -->
</section>

<footer class="bg-theme">
  <div
    class="container links pt-4 pb-2 row mx-auto line-break d-flex justify-content-around"
  >
    <a class="col-lg-3 pb-2 text-center " href="#">Track Shipping</a>
    <a class="col-lg-3 pb-2 text-center" href="#">Contact Us</a>
    <a class="col-lg-3 pb-2 text-center" href="#">Customer Care</a>
    <a class="col-lg-3 pb-2 text-center" href="#">About us</a>
  </div>
  <div class="copyright bg-theme py-2 text-center">
    <span>Copyright © 2022 | Timeless | Made by <a href="https://muhamedshahabas.github.io/">Muhamed Shahabas C</a></span>
  </div>
</footer>

<script>
    $.ajax({
      url: "/admin/dashboard",
      method: "PUT",
      success: (res) => {
        var orderData = res.data;
        let totalOrders = [];
        let revenuePerMonth = [];
        let avgBillPerOrder = [];
        let productsPerMonth = [];
        orderData.forEach((order) => {
          totalOrders.push(order.totalOrders);
          revenuePerMonth.push(order.revenue);
          avgBillPerOrder.push(order.avgBillPerOrder);
          productsPerMonth.push(order.totalProducts);
        });
        const ctx = document.getElementById("myChart");
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ],
            datasets: [
              {
                label: "Revenue",
                data: revenuePerMonth,
                borderWidth: 1,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgb(255, 99, 132)",
              },
              {
                label: "Avg. Bill per Order",
                data: avgBillPerOrder,
                borderWidth: 1,
                backgroundColor: "rgba(255, 159, 64, 0.2)",
                borderColor: "rgb(255, 159, 64)",
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
        const inTransit= 5
        const cancelled = 0
        const delivered = 3
        const ctz = document.getElementById("myChart3");
        new Chart(ctz, {
         type: 'doughnut',
          data: {
            labels: [
              'In-Transit',
              'Delivered',
              'Cancelled'
            ],
            datasets: [{
              label: 'Order Status',
              data: [inTransit, delivered, cancelled],
              backgroundColor: [
              'rgb(255, 205, 86,0.9)',
                'rgb(34,139,34,0.9)',
                'rgb(255,80,66,0.9)'
              ],
              hoverOffset: 10
            }]
          },
          options : {
              scales: {
                  xAxes: [{
                      gridLines: {
                          display:false
                      }
                  }],
                  yAxes: [{
                      gridLines: {
                          display:false
                      }   
                  }]
              }
          }
        });


        const cty = document.getElementById("myChart2");
        new Chart(cty, {
          type: "bar",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
              "Oct",
              "Nov",
              "Dec",
            ],
            datasets: [
              {
                label: "Orders",
                data: totalOrders,
                borderWidth: 1,

                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgb(54, 162, 235)",
              },
              {
                label: "Products sold",
                data: productsPerMonth,
                borderWidth: 1,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgb(75, 192, 192)",
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      },
    });
</script>
<script>
  if ( window.history.replaceState ) {
 window.history.replaceState( null, null, window.location.href );
  }
</script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"
    ></script>
    <script>
      $(function () {
      $("#dataTable").DataTable({
        rowReorder: {
            selector: 'td:nth-child(2)'
        },
        responsive: true
    } );
    new $.fn.dataTable.FixedHeader( table );
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  if ( window.history.replaceState ) {
 window.history.replaceState( null, null, window.location.href );
  }
</script>

</body>
</html>
